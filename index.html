<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oferta â€“ edycja 1:1 z DOCX</title>
  <!-- docx-preview: wierne odwzorowanie stylÃ³w z Worda (fonty, marginesy, listy, tabele, kolory, wciÄ™cia) -->
  <script src="https://unpkg.com/docx-preview/dist/docx-preview.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/docx-preview/dist/docx-preview.css"/>
  <style>
    :root {
      --border: #e5e7eb;
      --toolbar-bg: #f8fafc;
      --bg: #f3f4f6;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); }
    .shell { max-width: 1100px; margin: 18px auto; padding: 0 12px; }
    .toolbar {
      position: sticky; top: 0; z-index: 20; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
      padding: 10px; border: 1px solid var(--border); background: var(--toolbar-bg); border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
    }
    .toolbar button, .toolbar input[type="file"], .toolbar select {
      border: 1px solid var(--border); background: white; padding: 8px 10px; border-radius: 8px; cursor: pointer; font-size: 14px;
    }
    .toolbar input[type="file"] { padding: 6px; }
    .spacer { flex: 1; }
    /* Strony renderowane przez docx-preview */
    #viewer { background: transparent; display: flex; flex-direction: column; align-items: center; gap: 16px; padding: 16px 0; }
    #viewer .docx { box-shadow: 0 10px 25px rgba(0,0,0,.08); }
    /* Tryb edycji â€“ podÅ›wietl zaznaczenie */
    [contenteditable="true"]:focus { outline: 2px solid #93c5fd; outline-offset: 2px; }
    .hint { color: #6b7280; font-size: 12px; margin-left: 6px; }
    @media print { .shell, .toolbar { display: none !important; } body { background: white; } #viewer .docx{ box-shadow: none; } }
  </style>
</head>
<body>
  <div class="shell">
    <div class="toolbar">
      <label>
        ğŸ“„ Importuj DOCX
        <input id="file-input" type="file" accept=".docx" />
      </label>
      <button id="toggle-edit">âœï¸ WÅ‚Ä…cz edycjÄ™</button>
      <button id="bold"><b>B</b></button>
      <button id="italic"><i>I</i></button>
      <button id="underline"><u>U</u></button>
      <button id="ulist">â€¢ Lista</button>
      <button id="olist">1. Lista</button>
      <select id="block-format" title="Styl akapitu">
        <option value="p">Akapit</option>
        <option value="h1">NagÅ‚Ã³wek 1</option>
        <option value="h2">NagÅ‚Ã³wek 2</option>
        <option value="h3">NagÅ‚Ã³wek 3</option>
      </select>
      <button id="link">ğŸ”— Link</button>
      <button id="clear">âš WyczyÅ›Ä‡ format</button>
      <div class="spacer"></div>
      <button id="print">ğŸ–¨ï¸ PDF/Drukuj</button>
      <button id="export-html">â¬‡ï¸ Eksport HTML (1:1)</button>
    </div>
    <div class="hint">WskazÃ³wka: aby zachowaÄ‡ peÅ‚nÄ… zgodnoÅ›Ä‡ wizualnÄ…, edytuj bez zmiany ukÅ‚adu sekcji. Docx-preview odtwarza style, fonty, marginesy, listy, tabele i podziaÅ‚y stron 1:1.</div>
  </div>

  <div id="viewer"></div>

  <script>
    // Silnik DOCX â†’ HTML (wierne style)
    const viewer = document.getElementById('viewer');
    const { renderAsync } = window.docx || {};

    async function loadDocx(arrayBuffer){
      viewer.innerHTML = '';
      // Opcje renderowania dla dokÅ‚adnoÅ›ci
      const styleMap = undefined; // domyÅ›lne mapowanie â€“ najwierniejsze dla Worda
      await renderAsync(arrayBuffer, viewer, viewer, {
        className: 'docx', inWrapper: true, // jedna strona = jeden kontener
        experimental: true, ignoreLastRenderedPageBreak: false,
        debug: false,
      }, styleMap);
      // domyÅ›lnie wyÅ‚Ä…czona edycja
      setEditable(false);
    }

    // Import pliku .docx z dysku
    document.getElementById('file-input').addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const ab = await f.arrayBuffer();
      loadDocx(ab);
      // zapamiÄ™taj w przeglÄ…darce
      const b64 = await toBase64(f);
      localStorage.setItem('docx_b64', b64);
    });

    // Przywracanie ostatnio wgranego DOCX (jeÅ›li byÅ‚)
    (async function restore(){
      const b64 = localStorage.getItem('docx_b64');
      if (!b64) return;
      const ab = base64ToArrayBuffer(b64.split(',')[1] || b64);
      loadDocx(ab);
    })();

    // Tryb edycji (contenteditable na caÅ‚ym widoku)
    const toggleBtn = document.getElementById('toggle-edit');
    function setEditable(on){
      viewer.querySelectorAll('.docx').forEach(p => p.setAttribute('contenteditable', on ? 'true' : 'false'));
      toggleBtn.textContent = on ? 'ğŸ”’ Zablokuj edycjÄ™' : 'âœï¸ WÅ‚Ä…cz edycjÄ™';
    }
    let isEditable = false;
    toggleBtn.addEventListener('click', () => { isEditable = !isEditable; setEditable(isEditable); });

    // Proste komendy edycyjne
    const exec = (cmd, val=null) => document.execCommand(cmd, false, val);
    document.getElementById('bold').onclick = () => exec('bold');
    document.getElementById('italic').onclick = () => exec('italic');
    document.getElementById('underline').onclick = () => exec('underline');
    document.getElementById('ulist').onclick = () => exec('insertUnorderedList');
    document.getElementById('olist').onclick = () => exec('insertOrderedList');
    document.getElementById('clear').onclick = () => exec('removeFormat');
    document.getElementById('link').onclick = () => { const u = prompt('Adres URL'); if(u) exec('createLink', u); };
    document.getElementById('block-format').onchange = (e)=> exec('formatBlock', e.target.value);

    // Drukuj / PDF (systemowa â€Zapisz jako PDFâ€) â€“ zachowuje ukÅ‚ad A4
    document.getElementById('print').onclick = () => window.print();

    // Eksport HTML â€“ zapisuje dokÅ‚adnie to, co jest we viewer
    document.getElementById('export-html').onclick = () => {
      const html = `<!DOCTYPE html><html lang="pl"><head><meta charset="utf-8"><title>Oferta</title><style>${collectAppliedStyles()}</style></head><body>${viewer.innerHTML}</body></html>`;
      download('oferta-1-1.html', html, 'text/html');
    };

    function download(name, content, type){
      const blob = new Blob([content], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = name; a.click();
      URL.revokeObjectURL(url);
    }

    // Zbierz zastosowane style z domyÅ›lnego arkusza docx-preview, aby HTML byÅ‚ "samowystarczalny"
    function collectAppliedStyles(){
      let css = '';
      [...document.styleSheets].forEach(ss => {
        try { [...ss.cssRules].forEach(r => { css += r.cssText + '
'; }); } catch(e) { /* CORS â€“ pomijamy */ }
      });
      return css;
    }

    function toBase64(file){
      return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); });
    }
    function base64ToArrayBuffer(b64){
      const binary_string = atob(b64); const len = binary_string.length; const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) { bytes[i] = binary_string.charCodeAt(i); }
      return bytes.buffer;
    }
  </script>
</body>
</html>
